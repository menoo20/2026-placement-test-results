<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mostafa's Student Performance Analytics</title>
    <!-- Use Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-p: #8b5cf6;
            --accent-s: #ec4899;
            --level-1: #ef4444;
            /* Red */
            --level-2: #f59e0b;
            /* Orange */
            --level-3: #3b82f6;
            /* Blue */
            --level-4: #22c55e;
            /* Green */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Glassmorphism utility */
        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        header {
            padding: 2rem 1rem;
            text-align: center;
            background: linear-gradient(to right, var(--bg-color), #1e1b4b);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, var(--accent-p), var(--accent-s));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.3s;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .header-stats {
            display: inline-block;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-weight: 500;
        }

        .header-count {
            color: var(--accent-p);
            font-weight: bold;
            font-size: 1.1rem;
            margin-left: 0.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .nav-links {
                flex-direction: column;
                align-items: center;
            }

            nav {
                flex-wrap: wrap;
            }

            button.tab-btn {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .kpi-row {
                flex-direction: column;
            }

            main {
                padding: 0 1rem 1rem;
            }
        }

        /* Navigation Tabs */
        nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            padding: 0 1rem;
        }

        button.tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.1rem;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px;
        }

        button.tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        button.tab-btn.active {
            color: var(--text-primary);
            background: rgba(139, 92, 246, 0.1);
        }

        button.tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 3px;
            background: var(--accent-p);
            border-radius: 2px;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 0 2rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .tab-content {
            display: none;
            margin-bottom: 2rem;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Table Styles */
        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            padding: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            user-select: none;
            position: relative;
        }

        /* Sort Arrows */
        .sort-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-header:hover {
            color: var(--text-primary);
        }

        .sort-icon {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.3;
        }

        .sort-asc {
            border-bottom: 5px solid currentColor;
            margin-bottom: 2px;
        }

        .sort-desc {
            border-top: 5px solid currentColor;
            margin-top: 2px;
        }

        .sort-active {
            opacity: 1;
            color: var(--accent-p);
        }

        /* Filter Row Inputs */
        .filter-row th {
            padding: 0.5rem 1rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .filter-input {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-p);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .level-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .lvl-1 {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .lvl-2 {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .lvl-3 {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .lvl-4 {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* Statistics Layout */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            padding: 1.5rem;
            height: 400px;
            position: relative;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .kpi-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .kpi-card {
            flex: 1;
            padding: 1.5rem;
            text-align: center;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0.5rem 0;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Student Detail Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal-header h2 {
            font-size: 1.4rem;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-summary {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .modal-stat {
            flex: 1;
            min-width: 100px;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }

        .modal-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-p);
        }

        .modal-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .topic-grid {
            display: grid;
            gap: 0.75rem;
        }

        .topic-row {
            background: rgba(255, 255, 255, 0.03);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .topic-name {
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
        }

        .topic-score {
            font-weight: 600;
            color: var(--accent-s);
        }

        .topic-bar {
            flex: 1;
            max-width: 150px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .topic-bar-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-p), var(--accent-s));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .hint-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--accent-p);
        }

        .clickable-name {
            cursor: pointer;
            color: var(--accent-p);
            transition: color 0.2s;
        }

        .clickable-name:hover {
            color: var(--accent-s);
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .modal-summary {
                flex-direction: column;
            }

            .topic-row {
                flex-wrap: wrap;
            }

            .topic-bar {
                max-width: 100%;
                width: 100%;
                order: 3;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="nav-links">
            <a href="index.html" class="nav-link">
                <span>&larr;</span> Home
            </a>
            <a href="dashboard_ameen.html" class="nav-link">
                Mohammed's Dashboard <span>&rarr;</span>
            </a>
        </div>
        <h1>Mostafa's Student Performance Analytics</h1>
        <div class="header-stats" style="margin-bottom: 1rem;">
            Total Students: <span id="headerTotalStudents" class="header-count">--</span>
        </div>
        <p class="subtitle">Placement Test Analysis Dashboard</p>
    </header>

    <nav>
        <button class="tab-btn active" onclick="switchTab('tab-data')">Student List</button>
        <button class="tab-btn" onclick="switchTab('tab-stats')">Statistics</button>
        <button class="tab-btn" onclick="switchTab('tab-advanced')">Advanced Stats</button>
        <button class="tab-btn" onclick="switchTab('tab-recommendations')">Recommendations</button>
    </nav>

    <main>
        <!-- Tab 1: Data Table -->
        <div id="tab-data" class="tab-content active glass">
            <div style="padding: 1.5rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2 class="chart-title" style="text-align:left; margin:0;">All Students</h2>
                    <button onclick="resetFilters()"
                        style="padding:0.5rem 1rem; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:var(--accent-p); cursor:pointer;">Reset
                        Filters</button>
                </div>
                <div class="hint-text">
                    ðŸ’¡ <strong>Tip:</strong> Click on any student's name to view their detailed topic breakdown.
                </div>
                <div class="table-container">
                    <table id="studentTable">
                        <thead>
                            <tr>
                                <th onclick="handleSort('Name')">
                                    <div class="sort-header">
                                        Student Name
                                        <span id="sort-Name" class="sort-icon sort-asc"></span>
                                    </div>
                                </th>
                                <th onclick="handleSort('Accuracy')">
                                    <div class="sort-header">
                                        Accuracy
                                        <span id="sort-Accuracy" class="sort-icon sort-desc"></span>
                                    </div>
                                </th>
                                <th onclick="handleSort('Level')">
                                    <div class="sort-header">
                                        Level
                                        <span id="sort-Level" class="sort-icon sort-desc"></span>
                                    </div>
                                </th>
                            </tr>
                            <tr class="filter-row">
                                <th>
                                    <input type="text" id="filterName" class="filter-input" placeholder="Search Name..."
                                        onkeyup="filterData()">
                                </th>
                                <th>
                                    <div style="display:flex; gap:0.5rem;">
                                        <input type="number" id="filterAccMin" class="filter-input" placeholder="Min %"
                                            onkeyup="filterData()" style="width:50%">
                                        <input type="number" id="filterAccMax" class="filter-input" placeholder="Max %"
                                            onkeyup="filterData()" style="width:50%">
                                    </div>
                                </th>
                                <th>
                                    <select id="filterLevel" class="filter-input" onchange="filterData()">
                                        <option value="">All Levels</option>
                                        <option value="1">Level 1</option>
                                        <option value="2">Level 2</option>
                                        <option value="3">Level 3</option>
                                        <option value="4">Level 4</option>
                                    </select>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="pagination" style="text-align:center; padding:1rem; color:var(--text-secondary);">
                    Showing <span id="countDisplay">0</span> students
                </div>
            </div>
        </div>

        <!-- Tab 2: General Stats -->
        <div id="tab-stats" class="tab-content">
            <div class="kpi-row">
                <div class="kpi-card glass">
                    <div class="kpi-label">Total Students</div>
                    <div class="kpi-value" id="totalStudents">0</div>
                </div>
                <div class="kpi-card glass">
                    <div class="kpi-label">Average Accuracy</div>
                    <div class="kpi-value" id="avgAccuracy">0%</div>
                </div>
                <div class="kpi-card glass">
                    <div class="kpi-label">Top Level 4</div>
                    <div class="kpi-value" id="topLevelCount">0</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="glass chart-container">
                    <h3 class="chart-title">Level Distribution</h3>
                    <canvas id="levelChart"></canvas>
                </div>
                <div class="glass chart-container">
                    <h3 class="chart-title">Accuracy Spread</h3>
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab 3: Advanced Stats -->
        <div id="tab-advanced" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <!-- Radar Chart -->
                <div class="glass chart-container">
                    <h3 class="chart-title">Topic Mastery (Class Average)</h3>
                    <p style="text-align:center; color:var(--text-secondary); margin-bottom:1rem; font-size:0.9rem;">
                        Based on correct answers per topic.
                    </p>
                    <div style="height: 300px; position:relative;">
                        <canvas id="topicRadarChart"></canvas>
                    </div>
                </div>

                <!-- Distribution List -->
                <div class="glass chart-container" style="height:auto; min-height:300px;">
                    <h3 class="chart-title">Exam Structure (Topic Distribution)</h3>
                    <p style="text-align:center; color:var(--text-secondary); margin-bottom:1rem; font-size:0.9rem;">
                        Questions per topic & % of Exam
                    </p>
                    <ul id="topicDistribution" style="list-style:none; padding:0 1rem;">
                        <!-- Injected by JS -->
                    </ul>
                </div>
            </div>

        </div>
        </div>

        <!-- Tab 4: Recommendations -->
        <div id="tab-recommendations" class="tab-content">
            <div class="glass" style="padding: 2rem; border-left: 4px solid var(--accent-p);">
                <h2 style="color: var(--accent-p); margin-bottom: 1rem;">Teacher Recommendations</h2>
                <div style="font-size: 1.1rem; line-height: 1.8; color: var(--text-primary);">
                    <p style="margin-bottom: 1.5rem;">
                        <strong>Time Management:</strong><br>
                        "Finishing a lesson in a single day isn't practical due to varying student levels. While one or
                        two students may grasp the material in 45 minutes, most need at least five days of practice to
                        fully understand the lesson objectives."
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalStudentName">Student Name</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-summary">
                    <div class="modal-stat">
                        <div class="modal-stat-value" id="modalAccuracy">--</div>
                        <div class="modal-stat-label">Accuracy</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" id="modalLevel">--</div>
                        <div class="modal-stat-label">Level</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value" id="modalTotal">--</div>
                        <div class="modal-stat-label">Total Questions</div>
                    </div>
                </div>
                <h3 style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 1rem;">Topic Breakdown</h3>
                <div id="modalTopics" class="topic-grid"></div>
            </div>
        </div>
    </div>

    <!-- Data Source -->
    <script src="mostafa_dashboard_data.js"></script> <!-- Defines const studentData -->

    <script>
        // --- State ---
        let currentSort = { key: 'Name', dir: 1 }; // 1 = ASC, -1 = DESC
        let filteredData = [];

        // --- Logic ---
        function initDashboard() {
            // Update total students in header
            document.getElementById('headerTotalStudents').textContent = studentData.length;

            renderTable(studentData);
            renderStats(studentData);
            renderAdvanced(studentData);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            const index = ['tab-data', 'tab-stats', 'tab-advanced', 'tab-recommendations'].indexOf(tabId);
            document.querySelectorAll('.tab-btn')[index].classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof studentData === 'undefined') {
                console.error("Data not loaded");
                return;
            }
            // Initial Load
            filteredData = [...studentData];
            initDashboard(); // Sets header count and renders all views

            // Apply default sort? initDashboard calls renderTable.
            // But we need to filter first?
            // filterData() calls applySort and renderTable.

            // Let's just call filterData to start with Sort
            filterData();

        });

        // --- Filter & Sort ---
        function filterData() {
            const nameTerm = document.getElementById('filterName').value.toLowerCase();
            const minAcc = parseInt(document.getElementById('filterAccMin').value) || 0;
            const maxAcc = parseInt(document.getElementById('filterAccMax').value) || 100;
            const levelVal = document.getElementById('filterLevel').value;

            filteredData = studentData.filter(s => {
                const matchName = s.Name.toLowerCase().includes(nameTerm);
                const matchAcc = s.Accuracy >= minAcc && s.Accuracy <= maxAcc;
                const matchLevel = levelVal === "" || s.Level.toString() === levelVal;
                return matchName && matchAcc && matchLevel;
            });

            applySort(); // Sort the filtered list
            renderTable(filteredData);
        }

        function handleSort(key) {
            if (currentSort.key === key) {
                currentSort.dir *= -1; // Toggle
            } else {
                currentSort.key = key;
                currentSort.dir = 1; // Default ASC for new column
                if (key === 'Accuracy' || key === 'Level') currentSort.dir = -1; // Default DESC for numbers
            }
            updateSortIcons();
            applySort();
            renderTable(filteredData);
        }

        function applySort() {
            const key = currentSort.key;
            const dir = currentSort.dir;

            filteredData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });
        }

        function updateSortIcons() {
            // Reset all
            ['Name', 'Accuracy', 'Level'].forEach(k => {
                const icon = document.getElementById(`sort-${k}`);
                icon.className = 'sort-icon'; // Reset to base
                icon.parentElement.style.color = '';
            });

            // Set Active
            const activeIcon = document.getElementById(`sort-${currentSort.key}`);
            activeIcon.classList.add(currentSort.dir === 1 ? 'sort-asc' : 'sort-desc');
            activeIcon.classList.add('sort-active');
        }

        function resetFilters() {
            document.getElementById('filterName').value = '';
            document.getElementById('filterAccMin').value = '';
            document.getElementById('filterAccMax').value = '';
            document.getElementById('filterLevel').value = '';
            filterData();
        }

        // --- Render ---
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:2rem; color:var(--text-secondary);">No students found matching filters</td></tr>';
                document.getElementById('countDisplay').innerText = 0;
                return;
            }

            data.forEach((s, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="clickable-name" onclick="openModal(${index})">${s.Name}</span></td>
                    <td>${s.Accuracy}%</td>
                    <td><span class="level-badge lvl-${s.Level}">Level ${s.Level}</span></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('countDisplay').innerText = data.length;
        }

        // --- Modal Functions ---
        function openModal(index) {
            const student = filteredData[index];
            if (!student) return;

            document.getElementById('modalStudentName').innerText = student.Name;
            document.getElementById('modalAccuracy').innerText = student.Accuracy + '%';
            document.getElementById('modalLevel').innerText = 'Level ' + student.Level;

            let totalQ = 0;
            if (student.Topics) {
                Object.values(student.Topics).forEach(t => totalQ += t.Total);
            }
            document.getElementById('modalTotal').innerText = totalQ;

            const topicsContainer = document.getElementById('modalTopics');
            topicsContainer.innerHTML = '';

            const topicOrder = ["Simple MCQ", "Verb to Be", "Tenses", "Passive Voice", "Basic Vocabulary", "Advanced Vocabulary", "Advanced Grammar"];

            if (student.Topics) {
                topicOrder.forEach(topicName => {
                    const stats = student.Topics[topicName];
                    if (!stats) return;

                    const percent = stats.Total > 0 ? Math.round((stats.Correct / stats.Total) * 100) : 0;

                    const row = document.createElement('div');
                    row.className = 'topic-row';
                    row.innerHTML = `
                        <span class="topic-name">${topicName}</span>
                        <span class="topic-score">${stats.Correct}/${stats.Total}</span>
                        <div class="topic-bar">
                            <div class="topic-bar-fill" style="width: ${percent}%"></div>
                        </div>
                    `;
                    topicsContainer.appendChild(row);
                });
            }

            document.getElementById('studentModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('studentModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        function renderStats(data) {
            document.getElementById('totalStudents').innerText = data.length;
            document.getElementById('headerTotalStudents').innerText = data.length;
            const avg = data.reduce((sum, s) => sum + s.Accuracy, 0) / data.length;
            document.getElementById('avgAccuracy').innerText = Math.round(avg) + '%';
            document.getElementById('topLevelCount').innerText = data.filter(s => s.Level === 4).length;

            const levels = [0, 0, 0, 0];
            data.forEach(s => { if (s.Level >= 1 && s.Level <= 4) levels[s.Level - 1]++; });

            new Chart(document.getElementById('levelChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Level 1', 'Level 2', 'Level 3', 'Level 4'],
                    datasets: [{
                        data: levels,
                        backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } } }
            });

            const bins = [0, 0, 0, 0, 0];
            data.forEach(s => {
                const idx = Math.min(Math.floor(s.Accuracy / 20), 4);
                const cleanIdx = idx > 4 ? 4 : idx;
                bins[cleanIdx]++;
            });

            new Chart(document.getElementById('accuracyChart'), {
                type: 'bar',
                data: {
                    labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'],
                    datasets: [{
                        label: 'Students',
                        data: bins,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 5
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderAdvanced(data) {
            // Advanced stats logic remains same...
            // Defined Order (7 Topics, ignoring Fast Response)
            const topicOrder = [
                "Simple MCQ", "Verb to Be", "Tenses",
                "Passive Voice", "Basic Vocabulary", "Advanced Vocabulary", "Advanced Grammar"
            ];

            const topics = {};
            // Initialize with 0 for all desired topics to ensure they appear
            topicOrder.forEach(t => {
                topics[t] = { totalQ: 0, totalC: 0 };
            });

            data.forEach(s => {
                if (!s.Topics) return;
                for (const [topic, stats] of Object.entries(s.Topics)) {
                    // Normalize key if needed (e.g. casing), but script uses correct casing
                    if (!topics[topic]) topics[topic] = { totalQ: 0, totalC: 0 };
                    topics[topic].totalQ += stats.Total;
                    topics[topic].totalC += stats.Correct;
                }
            });

            // Sort labels based on topicOrder
            const labels = Object.keys(topics).sort((a, b) => {
                const idxA = topicOrder.indexOf(a);
                const idxB = topicOrder.indexOf(b);
                // If not in list, put at end
                return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
            });

            const percentages = labels.map(l => {
                const t = topics[l];
                // Avoid division by zero
                return t.totalQ > 0 ? Math.round((t.totalC / t.totalQ) * 100) : 0;
            });

            new Chart(document.getElementById('topicRadarChart'), {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Class Mastery %',
                        data: percentages,
                        backgroundColor: 'rgba(236, 72, 153, 0.2)',
                        borderColor: '#ec4899',
                        pointBackgroundColor: '#ec4899',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#ec4899'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#f8fafc', font: { size: 12 } },
                            ticks: { display: false, backdropColor: 'transparent' }
                        }
                    }
                }
            });

            // --- Topic Distribution Logic ---
            const distributionList = document.getElementById('topicDistribution');
            if (distributionList && data.length > 0 && data[0].Topics) {
                distributionList.innerHTML = '';

                // Use first student to determine exam structure
                // Iterate all students to find max total per topic to be safe against data gaps
                const topicTotals = {};
                let grandTotal = 0;

                // Find max questions per topic across all students (robustness)
                data.forEach(s => {
                    if (!s.Topics) return;
                    for (const [t, stats] of Object.entries(s.Topics)) {
                        if (!topicTotals[t] || stats.Total > topicTotals[t]) {
                            topicTotals[t] = stats.Total;
                        }
                    }
                });

                // Calculate grand total
                Object.values(topicTotals).forEach(c => grandTotal += c);

                // Convert to array and sort
                const sortedTopics = Object.entries(topicTotals)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count);

                sortedTopics.forEach(t => {
                    const pct = grandTotal > 0 ? Math.round((t.count / grandTotal) * 100) : 0;

                    const li = document.createElement('li');
                    li.style.marginBottom = '1rem';
                    li.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:0.25rem; font-size:0.95rem;">
                            <span style="color:var(--text-primary); font-weight:500;">${t.name}</span>
                            <span style="color:var(--accent-s); font-weight:bold;">${t.count} Qs <span style="color:var(--text-secondary); font-weight:normal; font-size:0.85rem;">(${pct}%)</span></span>
                        </div>
                        <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
                            <div style="height:100%; width:${pct}%; background:linear-gradient(90deg, var(--accent-p), var(--accent-s)); border-radius:3px;"></div>
                        </div>
                    `;
                    distributionList.appendChild(li);
                });

                // Add Total Summary
                const summaryLi = document.createElement('li');
                summaryLi.style.marginTop = '1.5rem';
                summaryLi.style.paddingTop = '1rem';
                summaryLi.style.borderTop = '1px solid rgba(255,255,255,0.1)';
                summaryLi.style.textAlign = 'center';
                summaryLi.innerHTML = `<span style="color:var(--text-secondary);">Total Exam Questions:</span> <strong style="color:var(--text-primary); font-size:1.1rem;">${grandTotal}</strong>`;
                distributionList.appendChild(summaryLi);
            }
        }
    </script>
</body>

</html>